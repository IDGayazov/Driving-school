{% extends 'base.html' %}

{% block title %}Практика{% endblock %}

{% block content %}
<h1>Записи на занятия</h1>

<!-- Форма для сортировки и фильтрации -->
<div class="filters">
    <form method="get" action="{% url 'lessons:lessons_list' %}">
        <label for="sort_by">Сортировать по дате:</label>
        <select name="sort_by" id="sort_by" onchange="this.form.submit()">
            <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>По возрастанию</option>
            <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>По убыванию</option>
        </select>

        <label for="filter_by">Фильтровать по статусу:</label>
        <select name="filter_by" id="filter_by" onchange="this.form.submit()">
            <option value="">Все</option>
            <option value="available" {% if filter_by == 'available' %}selected{% endif %}>Свободно</option>
            <option value="booked" {% if filter_by == 'booked' %}selected{% endif %}>Занято</option>
        </select>
    </form>
</div>

<!-- Список занятий -->
<div class="lesson-cards">
    {% for registration in registrations %}
        <div class="lesson-card" id="lesson-{{ registration.id }}">
            <h2>Занятие {{ registration.date }}</h2>
            <p><strong>Инструктор:</strong> {{ registration.instructor}}</p>
            <p><strong>Марка машины:</strong> {{ registration.car_brand }}</p>
            <p><strong>Гос номер машины:</strong> {{ registration.car_number }}</p>
            <p><strong>Статус:</strong> <span class="status">{{ registration.is_booked|yesno:"Занято,Свободно" }}</span></p>
            {% if user.is_authenticated %}
                {% if user.is_student %}
                    {% if not registration.is_booked %}
                        <button onclick="enrollLesson({{ registration.id }})" class="btn btn-primary">Записаться на занятие</button>
                    {% else %}
                        {% if registration.student.id == user.id %}
                            <p>Вы уже записаны на это занятие.</p>
                        {% else %}
                            <p>Это занятие уже занято другим студентом.</p>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p>Запись на занятие доступна только для студентов.</p>
                {% endif %}
            {% else %}
                <p>Войдите в систему, чтобы записаться на занятие.</p>
            {% endif %}
        </div>
    {% endfor %}
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<script>
function enrollLesson(lessonId) {
    const csrfToken = document.querySelector('[name=csrf-token]').content;  // Извлеките CSRF-токен
    fetch(`/lessons/enrollLesson/${lessonId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const lessonCard = document.getElementById(`lesson-${lessonId}`);
            lessonCard.querySelector('.status').textContent = 'Занято';
            lessonCard.querySelector('button').remove();
            lessonCard.insertAdjacentHTML('beforeend', '<p>Вы уже записаны на это занятие.</p>');
        } else {
            alert('Ошибка при записи на занятие.');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
}
</script>
{% endblock %}